(function(t){function e(e){for(var n,o,s=e[0],h=e[1],c=e[2],u=0,d=[];u<s.length;u++)o=s[u],Object.prototype.hasOwnProperty.call(a,o)&&a[o]&&d.push(a[o][0]),a[o]=0;for(n in h)Object.prototype.hasOwnProperty.call(h,n)&&(t[n]=h[n]);l&&l(e);while(d.length)d.shift()();return r.push.apply(r,c||[]),i()}function i(){for(var t,e=0;e<r.length;e++){for(var i=r[e],n=!0,s=1;s<i.length;s++){var h=i[s];0!==a[h]&&(n=!1)}n&&(r.splice(e--,1),t=o(o.s=i[0]))}return t}var n={},a={app:0},r=[];function o(e){if(n[e])return n[e].exports;var i=n[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=t,o.c=n,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(i,n,function(e){return t[e]}.bind(null,n));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/wear-a-mask/";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],h=s.push.bind(s);s.push=e,s=s.slice();for(var c=0;c<s.length;c++)e(s[c]);var l=h;r.push([0,"chunk-vendors"]),i()})({0:function(t,e,i){t.exports=i("56d7")},"034f":function(t,e,i){"use strict";var n=i("85ec"),a=i.n(n);a.a},1:function(t,e){},2:function(t,e){},3:function(t,e){},"4d24":function(t,e,i){t.exports=i.p+"img/logo-title.02b87219.svg"},"56d7":function(t,e,i){"use strict";i.r(e);i("e260"),i("e6cf"),i("cca6"),i("a79d");var n=i("2b0e"),a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"app"}},[t._m(0),i("div",{attrs:{id:"contentContainer"}},[i("div",{attrs:{id:"content"}},[i("Index",{directives:[{name:"show",rawName:"v-show",value:"index"==t.nav,expression:"nav=='index'"}],on:{navTo:t.navTo}}),i("Editor",{directives:[{name:"show",rawName:"v-show",value:"editor"==t.nav,expression:"nav=='editor'"}],attrs:{fileId:t.currentFileId},on:{navTo:t.navTo}}),"export"==t.nav?i("Export",{on:{navTo:t.navTo}}):t._e()],1)])])},r=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{attrs:{id:"header"}},[n("img",{attrs:{id:"logo",src:i("4d24")}}),n("a",{attrs:{id:"forkMe",href:"https://github.com/zamhown/wear-a-mask"}},[t._v("Fork me on GitHub!")])])}],o=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"index"},[t._m(0),i("p",{staticClass:"title"},[t._v("疫情当前，有罩才稳")]),i("p",{staticClass:"slogan"},[t.wide?t._e():i("span",{domProps:{innerHTML:t._s(t.space)}}),t._v("给社交网络头像戴上口罩，"),t.wide?t._e():i("br"),t.wide?t._e():i("span",{domProps:{innerHTML:t._s(t.space)}}),t._v("提醒更多人关注身体健康。")]),i("div",{staticClass:"upload"},[i("span",[t._v("选择图片")]),i("input",{ref:"inputer",staticClass:"upload",attrs:{type:"file",accept:"image/png,image/jpeg,image/gif,image/jpg"},on:{change:t.addImg}})]),i("p",{staticClass:"description"},[t._v("此页面可以在你的头像上自动P上口罩，你还可以对口罩的位置和大小进行编辑。")]),i("p",{staticClass:"description"},[t._v("人脸检测算法基于SSD MobileNet V1神经网络模型，无需上传图片，也不会保留任何数据。")])])},s=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("p",[n("img",{staticClass:"example",attrs:{src:i("96e3")}})])}],h={data:function(){return{space:"　",wide:!1}},methods:{addImg:function(){var t=this.$refs.inputer;if(1==t.files.length){var e={file:t.files[0],id:(new Date).getTime()};this.$store.commit("setUserImgInfo",e),this.$emit("navTo","editor",e.id)}}},mounted:function(){this.wide=this.$refs.index.clientWidth>500}},c=h,l=(i("e99a"),i("2877")),u=Object(l["a"])(c,o,s,!1,null,"03165009",null),d=u.exports,g=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"editor",attrs:{id:"editor"}},[i("div",{class:{loading:t.loading},attrs:{id:"editorUI"}},[i("div",{ref:"canvasContainer"}),i("button",{attrs:{id:"resumeBtn"},on:{click:t.resumeMask}},[t._v("重置")]),i("div",{ref:"maskStore",attrs:{id:"maskStore"}},[i("p",{staticClass:"title"},[t._v("更换口罩")]),i("div",{staticClass:"list"},[i("ul",t._l(t.maskData.masks,(function(e){return i("li",{key:e.name,on:{click:function(i){return t.changeMask(e)}}},[i("img",{attrs:{src:t.maskData.baseUrl+e.name}})])})),0)])]),i("div",{ref:"control",staticClass:"control"},[i("button",{attrs:{id:"reuploadBtn"},on:{click:t.reupload}},[t._v("重选图片")]),i("button",{attrs:{id:"saveBtn"},on:{click:t.save}},[t._v("保存图片")])])]),t.loading?i("div",{attrs:{id:"loading"}},[t._m(0)]):t._e()])},f=[function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("p",[i("b",[t._v("正在进行人脸检测，请稍等……")]),i("br"),t._v(" 由于算法全程在浏览器运行， "),i("br"),t._v(" 运算速度可能取决于设备性能。 ")])])}],m=(i("a9e3"),i("4160"),i("d3b7"),i("3ca3"),i("159b"),i("ddb0"),i("96cf"),i("1da1")),v=i("ab39"),p=(i("4de4"),i("b0c0"),i("2af1"),i("2b3d"),i("3835")),w={maskBaseUrl:"https://zamhown.github.io/wear-a-mask/masks/",modelBaseUrl:"https://zamhown.github.io/wear-a-mask/weights"},P={baseUrl:w.maskBaseUrl,masks:[{name:"n1.png",width:256,height:256,side:0,leftPoint:[4,90],rightPoint:[248,90],bottomPoint:[130,216]},{name:"n2.png",width:256,height:256,side:0,leftPoint:[3,71],rightPoint:[255,71],bottomPoint:[129,231]},{name:"n3.png",width:256,height:256,side:0,leftPoint:[6,81],rightPoint:[249,81],bottomPoint:[131,246]},{name:"n4.png",width:256,height:256,side:0,leftPoint:[4,69],rightPoint:[252,69],bottomPoint:[137,234]},{name:"n5.png",width:256,height:256,side:0,leftPoint:[13,47],rightPoint:[248,47],bottomPoint:[163,222]},{name:"n6.png",width:256,height:256,side:0,leftPoint:[7,56],rightPoint:[251,56],bottomPoint:[108,243]},{name:"n7.png",width:256,height:256,side:0,leftPoint:[7,78],rightPoint:[247,78],bottomPoint:[123,230]},{name:"n8.png",width:256,height:256,side:0,leftPoint:[17,77],rightPoint:[248,77],bottomPoint:[131,250]},{name:"n9.png",width:256,height:256,side:0,leftPoint:[61,156],rightPoint:[223,156],bottomPoint:[137,247]},{name:"n10.png",width:256,height:256,side:1,leftPoint:[8,100],rightPoint:[225,100],bottomPoint:[92,240]},{name:"n11.png",width:256,height:256,side:1,leftPoint:[37,86],rightPoint:[221,86],bottomPoint:[80,243]},{name:"n12.png",width:256,height:256,side:0,leftPoint:[8,65],rightPoint:[250,65],bottomPoint:[127,242]},{name:"n13.png",width:256,height:256,side:0,leftPoint:[10,86],rightPoint:[249,86],bottomPoint:[126,244]},{name:"n14.png",width:256,height:256,side:0,leftPoint:[10,97],rightPoint:[246,97],bottomPoint:[122,210]},{name:"n15.png",width:256,height:256,side:2,leftPoint:[3,63],rightPoint:[209,63],bottomPoint:[143,241]},{name:"n16.png",width:256,height:256,side:0,leftPoint:[11,88],rightPoint:[240,88],bottomPoint:[123,210]},{name:"n17.png",width:256,height:256,side:0,leftPoint:[9,59],rightPoint:[236,59],bottomPoint:[95,248]},{name:"n18.png",width:256,height:256,side:0,leftPoint:[13,93],rightPoint:[244,93],bottomPoint:[133,226]},{name:"n19.png",width:256,height:256,side:0,leftPoint:[15,45],rightPoint:[247,45],bottomPoint:[165,247]},{name:"n20.png",width:256,height:256,side:0,leftPoint:[8,77],rightPoint:[246,77],bottomPoint:[127,242]},{name:"n21.png",width:256,height:256,side:0,leftPoint:[11,65],rightPoint:[246,65],bottomPoint:[129,251]},{name:"n22.png",width:256,height:256,side:0,leftPoint:[31,107],rightPoint:[215,107],bottomPoint:[123,232]},{name:"n23.png",width:256,height:256,side:0,leftPoint:[19,93],rightPoint:[239,93],bottomPoint:[125,232]},{name:"n24.png",width:256,height:256,side:0,leftPoint:[19,72],rightPoint:[242,72],bottomPoint:[154,251]}]},b={getMidPoint:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(e,2),o=r[0],s=r[1];return[(n+o)/2,(a+s)/2]},makeLine:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(e,2),o=r[0],s=r[1];return[a-s,o-n,(n-o)*s+(s-a)*o]},pointDistance:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(e,2),o=r[0],s=r[1];return Math.sqrt((n-o)*(n-o)+(a-s)*(a-s))},pointLineDistance:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(e,3),o=r[0],s=r[1],h=r[2];return Math.abs(o*n+s*a+h)/Math.sqrt(o*o+s*s)},makePerpendicularLine:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(e,2),o=r[0],s=r[1];return[-a,n,a*o-n*s]},getCrossPointOfTwoLines:function(t,e){var i=Object(p["a"])(t,3),n=i[0],a=i[1],r=i[2],o=Object(p["a"])(e,3),s=o[0],h=o[1],c=o[2],l=n*h-s*a;return[(a*c-h*r)/l,(s*r-n*c)/l]},getPerpendicularPoint:function(t,e){return this.getCrossPointOfTwoLines(t,this.makePerpendicularLine(t,e))},getAngle:function(t,e,i){var n=Object(p["a"])(t,2),a=n[0],r=n[1],o=Object(p["a"])(e,2),s=o[0],h=o[1],c=Object(p["a"])(i,2),l=c[0],u=c[1],d=s-a,g=r-h,f=l-a,m=r-u,v=Math.sqrt(d*d+g*g)*Math.sqrt(f*f+m*m);if(0===v)return-1;var w=Math.acos((d*f+g*m)/v),P=a-l,b=r-u;return P<0&&b<0?w:P<0&&b>0?w:P>0&&b<0?2*Math.PI-w:P>0&&b>0?2*Math.PI-w:null}},k=i("af87");function y(t){return[t.x,t.y]}var I={maskImageSrc:{},findMask:function(t,e,i,n){var a=this,r=Number.MAX_VALUE,o=null;return P.masks.filter((function(t){return 0==t.side&&0==n||t.side*n>0})).forEach((function(s){var h=b.pointDistance(s.leftPoint,s.rightPoint),c=b.pointDistance(s.leftPoint,s.bottomPoint),l=b.pointLineDistance(s.bottomPoint,b.makeLine(s.leftPoint,s.rightPoint)),u=Math.sqrt(c*c-l*l),d=u/h,g=Object(p["a"])(t,2),f=g[0],m=g[1],v=Object(p["a"])(e,2),w=v[0],P=v[1];if(0==s.side&&0==n||s.side==n){var y=f+(w-f)*d,I=m+(P-m)*d,M=b.makePerpendicularLine(b.makeLine(t,e),[y,I]),x=b.pointLineDistance(i,M);r>x&&(r=x,o=k["Object"].assign({overturn:!1,transform:a.computeTransform(s.leftPoint,s.rightPoint,s.bottomPoint,t,e,b.getPerpendicularPoint(M,i),s.width,s.height)},s))}if(0==s.side&&0==n||s.side!=n){var _=w+(f-w)*d,L=P+(m-P)*d,O=b.makePerpendicularLine(b.makeLine(t,e),[_,L]),j=b.pointLineDistance(i,O);r>j&&(r=j,o=k["Object"].assign({overturn:!0,transform:a.computeTransform([s.width-s.leftPoint[0],s.leftPoint[1]],[s.width-s.rightPoint[0],s.rightPoint[1]],[s.width-s.bottomPoint[0],s.bottomPoint[1]],t,e,b.getPerpendicularPoint(O,i),s.width,s.height)},s))}})),o},computeTransform:function(t,e,i,n,a,r,o,s){var h=b.pointDistance(n,a),c=h/b.pointDistance(t,e),l=b.pointLineDistance(r,b.makeLine(n,a))/b.pointLineDistance(i,b.makeLine(t,e));return{xScale:c,yScale:l,centerX:(o/2-t[0])*c+n[0],centerY:(s/2-t[1])*c+n[1],angle:b.getAngle(n,[n[0]+h*Math.sign(a[0]-n[0]),n[1]],a)}},wearAMaskAfterFaceDetection:function(t,e,i){var n=t.landmarks.positions,a=b.getMidPoint(y(n[1]),y(n[2])),r=b.getMidPoint(y(n[15]),y(n[14])),o=y(n[8]),s=y(n[28]),h=0;s.x>r.x?(r=s,h=2):s.x<a.x&&(a=s,h=1);var c={mask:this.findMask(a,r,o,h),imgOriginalWidth:t.detection.imageWidth,imgOriginalHeight:t.detection.imageHeight};return this.wearAMaskNormally(c,e,i)},wearAMaskNormally:function(t,e,i){var n=t.mask,a=i.width/t.imgOriginalWidth,r=i.height/t.imgOriginalHeight,o=n.width*n.transform.xScale*(n.overturn?-1:1)*a;return this.getMaskImageSrc(n,(function(t){e.layers.length>1&&e.removeItem(1),e.addPhoto(t,{width:o,height:n.height*n.transform.yScale*r,centerX:n.transform.centerX*a+i.position[0]-(n.overturn?o:0),centerY:n.transform.centerY*r+i.position[1],angle:n.transform.angle},!0),e.chooseItem(1)})),t},wearAMaskAsAFool:function(t,e){var i=P.masks[2];return this.getMaskImageSrc(i,(function(i){t.layers.length>1&&t.removeItem(1),t.addPhoto(i,{width:e.width/4,height:e.height/4,centerX:t.width/2,centerY:t.height/2,angle:0},!0),t.chooseItem(1)})),{mask:i}},resumeMask:function(t,e,i){t.imgOriginalWidth?this.wearAMaskNormally(t,e,i):this.wearAMaskAsAFool(e,i)},changeMask:function(t,e){var i=e.layers[1].rect;e.removeItem(1),this.getMaskImageSrc(t,(function(t){e.addPhoto(t,{width:i.width,height:i.height,centerX:i.center[0],centerY:i.center[1],angle:i.angle},!0),e.chooseItem(1)}))},getMaskImageSrc:function(t,e){if(this.maskImageSrc[t.name])e(this.maskImageSrc[t.name]);else{var i=this,n=new XMLHttpRequest;n.onload=function(){var n=URL.createObjectURL(this.response);i.maskImageSrc[t.name]=n,e(n)},n.open("GET",P.baseUrl+t.name,!0),n.responseType="blob",n.send()}}},M=w.modelBaseUrl,x={detectPic:function(t,e,i,n,a){var r=!1,o=function(){r=!0};Promise.all([v["c"].faceLandmark68Net.loadFromUri(M).catch(o),v["c"].faceLandmark68Net.loadFromUri(M).catch(o),v["c"].ssdMobilenetv1.loadFromUri(M).catch(o)]).then(Object(m["a"])(regeneratorRuntime.mark((function o(){var s,h,c;return regeneratorRuntime.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(r){o.next=9;break}return s=new v["a"]({minConfidence:.2}),o.next=4,v["b"](t,s).withFaceLandmarks();case 4:h=o.sent,console.log(h),h?(c=I.wearAMaskAfterFaceDetection(h,e,i),n&&n(c)):a&&a("no result"),o.next=10;break;case 9:a&&a("no result");case 10:case"end":return o.stop()}}),o)}))))},drawFaceLandmarks:function(t,e,i){var n=t.getContext("2d");e.forEach((function(t){var e=i.width/t.detection.imageWidth,a=i.height/t.detection.imageHeight;t.landmarks.positions.forEach((function(t,r){var o=t.x*e+i.position[0],s=t.y*a+i.position[1];n.fillStyle="#0000FF",n.fillRect(o-2,s-2,4,4),n.font="12px bold 宋体",n.fillText(r,o,s)}))}))}},_=(i("99af"),i("cb29"),i("d81d"),i("13d5"),i("a434"),i("d4ec")),L=i("bee2"),O=function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(e,2),o=r[0],s=r[1];return(n*o+a*s)/Math.sqrt(n*n+a*a)},j=function(t){var e=t;"string"===typeof t&&(e=document.querySelector(e));var i=e.offsetLeft,n=e.offsetTop,a=e.offsetParent;while(a)i+=a.offsetLeft,n+=a.offsetTop,a=a.offsetParent;return{x:i,y:n}},E=function(){function t(e){Object(_["a"])(this,t),this.canvas=e}return Object(L["a"])(t,[{key:"refresh",value:function(t){var e=this;this.rect=t,this.points=this.rect.points,this.cPoints=[],this.points.reduce((function(t,i){return e.cPoints.push([(t[0]+i[0])/2,(t[1]+i[1])/2]),i}),this.points[3]),t.height>=0?this.rPoint=[(this.points[0][0]+this.points[1][0])/2,this.points[0][1]-35]:this.rPoint=[(this.points[2][0]+this.points[3][0])/2,this.points[0][1]+35],this.draw()}},{key:"draw",value:function(){var t=this.rect,e=t.points,i=t.center,n=t.angle,a=t.width,r=t.height,o=this.canvas.context,s=Object(p["a"])(i,2),h=s[0],c=s[1];o.save(),o.translate(h,c),o.rotate(n),o.beginPath(),o.globalAlpha=.5,o.lineWidth="3",o.strokeStyle="#FF9999",o.rect(e[0][0]-h,e[0][1]-c,a,r),o.moveTo((e[0][0]+e[1][0])/2-h,e[0][1]-c),o.lineTo(this.rPoint[0]-h,this.rPoint[1]-c),o.stroke(),o.closePath(),o.globalAlpha=1;var l=e.concat(this.cPoints);l.forEach((function(t){var e=Object(p["a"])(t,2),i=e[0],n=e[1];o.fillStyle="#FF4949",o.fillRect(i-7-h,n-7-c,14,14)})),l.push(this.rPoint),o.beginPath(),o.strokeStyle="#FF4949",o.fillStyle="#FF9999",o.lineWidth="5",o.arc(this.rPoint[0]-h,this.rPoint[1]-c,8,0,2*Math.PI,!0),o.stroke(),o.closePath(),o.fill(),o.restore()}},{key:"isPointInSkeletion",value:function(t){var e=this,i=null,n=Object(p["a"])(t,2),a=n[0],r=n[1],o=this.rect.angle,s=this.rect.rotatePoint(this.rPoint,o),h=this.points.map((function(t){return e.rect.rotatePoint(t,o)})),c=this.cPoints.map((function(t){return e.rect.rotatePoint(t,o)}));return function(){var t=Object(p["a"])(s,2),e=t[0],n=t[1];Math.sqrt(Math.pow(e-a,2)+Math.pow(n-r,2))<10&&(i="r_point")}(),h.forEach((function(t,e){var n=Object(p["a"])(t,2),o=n[0],s=n[1];Math.sqrt(Math.pow(o-a,2)+Math.pow(s-r,2))<10&&(i="point_".concat(e+1))})),c.forEach((function(t,e){var n=Object(p["a"])(t,2),o=n[0],s=n[1];Math.sqrt(Math.pow(o-a,2)+Math.pow(s-r,2))<10&&(i="c_point_".concat(e+1))})),i}}]),t}(),T=function(){function t(e,i,n,a){Object(_["a"])(this,t),this.height=i,this.width=e,this.center=n,this.angle=a,this.getPoints()}return Object(L["a"])(t,[{key:"getPoints",value:function(){var t=this.height,e=this.width,i=Object(p["a"])(this.center,2),n=i[0],a=i[1],r=[];r[0]=[n-e/2,a-t/2],r[1]=[n+e/2,a-t/2],r[2]=[n+e/2,a+t/2],r[3]=[n-e/2,a+t/2],this.points=r}},{key:"rotate",value:function(t){this.angle=t*Math.sign(this.height)}},{key:"translate",value:function(t){var e=Object(p["a"])(t,2),i=e[0],n=e[1],a=this.points.map((function(t){return[t[0]+i,t[1]+n]}));this.points=a,this.getCenter()}},{key:"zoom",value:function(t,e){var i=this,n=parseFloat(e[0]),a=parseFloat(e[1]),r=this.angle,o=Math.sin(r+Math.PI/2),s=Math.cos(r+Math.PI/2);0===r&&(o=1,s=0);var h=O([o,s],[n,-a]),c=5*Math.sin(r),l=5*Math.cos(r),u=O([c,l],[n,-a]),d=Math.atan(this.height/this.width),g=function(t){var e=O([-Math.cos(t),Math.sin(t)],[n,-a]);i.width+=e*Math.cos(d),i.height+=e*Math.sin(d),i.center=[i.center[0]-e*Math.cos(t)/2,i.center[1]-e*Math.sin(t)/2]};if("point_1"===t){var f=d+r;g(f)}else if("point_2"===t){var m=Math.PI-d+r;g(m)}else if("point_3"===t){var v=Math.PI+d+r;g(v)}else if("point_4"===t){var p=2*Math.PI-d+r;g(p)}else"c_point_1"===t?(this.width-=h,this.center=[this.center[0]+h*Math.cos(r)/2,this.center[1]+h*Math.sin(r)/2]):"c_point_2"===t?(this.height+=u,this.center=[this.center[0]+u*Math.sin(r)/2,this.center[1]-u*Math.cos(r)/2]):"c_point_3"===t?(this.width+=h,this.center=[this.center[0]+h*Math.cos(r)/2,this.center[1]+h*Math.sin(r)/2]):"c_point_4"===t&&(this.height-=u,this.center=[this.center[0]+u*Math.sin(r)/2,this.center[1]-u*Math.cos(r)/2]);this.getPoints()}},{key:"isPointInRect",value:function(t){var e=this,i=this.points.map((function(t){return e.rotatePoint(t,e.angle)})),n=i[0],a=i[1],r=i[2],o=i[3],s=t[0],h=-t[1],c=function(){var t=(n[1]-a[1])/(a[0]-n[0]),e=-n[1]-t*n[0],i=-r[1]-t*r[0];return e>i&&t*s+e>h&&t*s+i<h||e<i&&t*s+e<h&&t*s+i>h}(),l=function(){var t=(a[1]-r[1])/(r[0]-a[0]),e=-a[1]-t*a[0],i=-o[1]-t*o[0];return r[0]-a[0]===0&&(n[0]<s&&s<a[0]||n[0]>s&&s>a[0])||(e>i&&t*s+e>h&&t*s+i<h||e<i&&t*s+e<h&&t*s+i>h)}();return!(!c||!l)}},{key:"getCenter",value:function(){var t=this.points[0],e=this.points[2],i=t[0]+e[0],n=t[1]+e[1];this.center=[i/2,n/2]}},{key:"rotatePoint",value:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],r=Object(p["a"])(this.center,2),o=r[0],s=r[1],h=(n-o)*Math.cos(e)-(a-s)*Math.sin(e)+o,c=(n-o)*Math.sin(e)+(a-s)*Math.cos(e)+s;return[h,c]}},{key:"setWH",value:function(){this.height=Math.abs(this.points[0][1]-this.points[3][1]),this.width=Math.abs(this.points[0][0]-this.points[1][0])}}]),t}(),C=function(){function t(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];Object(_["a"])(this,t),this.canvas=i,this.imgInput=e,this.image=null,this.onLoad=n,this.rect=a,this.canEdit=r,this.id=(new Date).getTime(),this.isLoad=!1,e instanceof t?(this.options=e,this.imgInput=this.options.imgInput,this.id=this.options.id):e instanceof Image&&(this.image=e),this.prepare()}return Object(L["a"])(t,[{key:"prepare",value:function(){var t=this;"string"===typeof this.imgInput?(this.image=new Image,this.image.onload=function(){t.isLoad||(t.isLoad=!0,t.init())},this.image.src=this.imgInput,this.image.complete&&(this.isLoad=!0,this.init())):this.image?(this.isLoad=!0,this.init()):(this.image=this.imgInput,this.isLoad=!0,this.init())}},{key:"init",value:function(){if(this.onLoad&&this.onLoad(),!this.rect)if(this.options){var t=this.options.rect,e=t.width,i=t.height,n=t.center,a=t.angle;this.rect=new T(e,i,[n[0],n[1]],a)}else this.rect=new T(this.image.width,this.image.height,[this.canvas.width/2,this.canvas.height/2],0)}},{key:"draw",value:function(){var t=this.image,e=this.canvas,i=this.rect,n=e.context,a=i.points,r=Object(p["a"])(i.center,2),o=r[0],s=r[1];n.save(),n.translate(o,s),n.rotate(i.angle),n.scale(Math.sign(i.width),Math.sign(i.height)),n.drawImage(t,0,0,t.width,t.height,a[0][0]-o,a[0][1]-s,i.width,i.height),n.restore()}}]),t}(),S=function(){function t(e){Object(_["a"])(this,t),this.options=e;var i=this.options,n=i.canvas,a=i.height,r=i.width,o=i.target,s=i.beforeLoading,h=i.afterLoading,c=i.data,l=void 0===c?[]:c;this.canvas=null,this.height=a,this.width=r,this.target=o,this.beforeLoading=s,this.afterLoading=h,this.data=l,this.layers=[],this.canvas="string"===typeof n?document.getElementById(n):n,this.target="string"===typeof o?document.getElementById(o):o,this.canvas.width=r,this.canvas.height=a,this.context=this.canvas.getContext("2d"),this.loadingLayerCount=0,this.border=new E(this),this.current=null,this.init(),this.initEvent()}return Object(L["a"])(t,[{key:"init",value:function(){var t=this;this.clear(),this.beforeLoading&&this.beforeLoading(this);var e=function(e){t.loadingLayerCount+=1;var i=new C(e,t,(function(){setTimeout((function(){t.loadingLayerCount-=1,t.loadingLayerCount<1&&t.draw()}),100)}),e.rect,e.canEdit);t.layers.push(i)};this.data.forEach((function(t){"function"!==typeof t&&e(t)})),this.afterLoading&&this.afterLoading(this)}},{key:"initEvent",value:function(){var e=this;this.target.addEventListener("mousedown",(function(i){var n=i.pageX,a=i.pageY,r=j(e.target),o=e.width/e.target.offsetWidth,s=[(n-r.x)*o,(a-r.y)*o],h=e.selectPhoto(s);if(h){var c=function(i){var s=i.pageX,c=i.pageY,l=[(s-n)*o,(c-a)*o];if(1===h)e.current.rect.translate(l);else if("r_point"===h){var u=[(s-r.x)*o,(c-r.y)*o],d=t.getAngle(e.current.rect.center,e.border.rPoint,u);if(isNaN(d))return;e.current.rect.rotate(d)}else e.current.rect.zoom(h,l);e.draw(),n=s,a=c};e.target.addEventListener("mousemove",c),e.target.addEventListener("mouseup",(function(){e.target.removeEventListener("mousemove",c)}))}})),this.target.addEventListener("touchstart",(function(i){i.preventDefault();var n=i.touches[0].pageX,a=i.touches[0].pageY,r=j(e.target),o=e.width/e.target.offsetWidth,s=[(n-r.x)*o,(a-r.y)*o],h=e.selectPhoto(s);if(h){var c=function(i){var s=i.touches[0].pageX,c=i.touches[0].pageY,l=[(s-n)*o,(c-a)*o];if(1===h)e.current.rect.translate(l);else if("r_point"===h){var u=[(s-r.x)*o,(c-r.y)*o],d=t.getAngle(e.current.rect.center,e.border.rPoint,u);if(isNaN(d))return;e.current.rect.rotate(d)}else e.current.rect.zoom(h,l);e.draw(),n=s,a=c};e.target.addEventListener("touchmove",c),e.target.addEventListener("touchend",(function(){e.target.removeEventListener("touchmove",c)}))}}))}},{key:"addCommand",value:function(t){var e=this;this.layers.push(t),this.loadingLayerCount>0?setTimeout((function(){e.draw()}),100):this.draw()}},{key:"addPhoto",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=null;if(i&&(a=new T(i.width,i.height,[i.centerX,i.centerY],i.angle)),"string"===typeof t){this.loadingLayerCount+=1;var r=new C(t,this,(function(){setTimeout((function(){e.loadingLayerCount-=1,e.loadingLayerCount<1&&e.draw()}),100)}),a,n);this.layers.push(r)}else{var o=new C(t,this,null,a,n);this.layers.push(o),this.draw()}}},{key:"selectPhoto",value:function(t){var e=this;if(this.current){var i=this.border.isPointInSkeletion(t);if(i)return i}var n=[].concat(this.layers).reverse();this.current=null;var a=0;return n.forEach((function(i,n){"function"!==typeof i&&!e.current&&i.rect.isPointInRect(t)&&i.canEdit&&(e.current=i,a=n+1)})),this.current?(this.chooseItem(this.layers.length-a),1):(this.draw(),0)}},{key:"chooseItem",value:function(t){this.layers[t].canEdit&&(this.current=this.layers[t],this.layers.splice(t,1),this.layers.push(this.current),this.draw())}},{key:"removeItem",value:function(t){this.layers.splice(t,1),this.draw()}},{key:"export",value:function(){var t=document.createElement("canvas"),e=this.layers[0];t.width=e.image.width,t.height=e.image.height;var i=t.getContext("2d");i.drawImage(e.image,0,0,e.image.width,e.image.height,0,0,t.width,t.height);var n=e.image.width/e.rect.width,a=e.image.height/e.rect.height,r=e.rect.center[0]-e.rect.width/2,o=e.rect.center[1]-e.rect.height/2;if(this.layers[1]){var s=this.layers[1],h=s.rect.points,c=Object(p["a"])(s.rect.center,2),l=c[0],u=c[1];l=(l-r)*n,u=(u-o)*a,i.save(),i.translate(l,u),i.rotate(s.rect.angle),i.scale(Math.sign(s.rect.width),Math.sign(s.rect.height)),i.drawImage(s.image,0,0,s.image.width,s.image.height,(h[0][0]-r)*n-l,(h[0][1]-o)*a-u,s.rect.width*n,s.rect.height*a),i.restore()}return t.toDataURL("image/png")}},{key:"clear",value:function(){this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.width,this.height),this.context.restore()}},{key:"save",value:function(){var t=this.layers.map((function(t){var e=t.rect,i=t.id,n=t.img;return{rect:e,id:i,img:n}}));return t}},{key:"draw",value:function(){var t=this;this.clear(),this.layers.forEach((function(e){"function"===typeof e?e.apply(null,t.context,t.canvas):e.draw()})),this.current&&this.border.refresh(this.current.rect)}}],[{key:"getAngle",value:function(t,e,i){var n=e[0]-t[0],a=t[1]-e[1],r=i[0]-t[0],o=t[1]-i[1],s=Math.sqrt(n*n+a*a)*Math.sqrt(r*r+o*o);if(0===s)return-1;var h=Math.acos((n*r+a*o)/s);return t[0]-i[0]<0&&t[1]-i[1]<0?h:t[0]-i[0]<0&&t[1]-i[1]>0?h:t[0]-i[0]>0&&t[1]-i[1]<0?2*Math.PI-h:t[0]-i[0]>0&&t[1]-i[1]>0?2*Math.PI-h:null}}]),t}(),F=S,D={props:{fileId:Number},data:function(){return{currentFileId:0,editor:null,canvas:null,maskData:P,maskInfo:null,realImgInfo:null,loading:!1}},methods:{loadImg:function(t){this.canvas&&this.canvas.remove(),this.canvas=document.createElement("canvas"),this.canvas.width=this.$refs.editor.clientWidth,this.canvas.height=this.$refs.editor.clientHeight-this.$refs.maskStore.clientHeight-this.$refs.control.clientHeight,this.$refs.canvasContainer.appendChild(this.canvas),this.editor=new F({canvas:this.canvas,target:this.canvas,width:this.canvas.width,height:this.canvas.height});var e=this.editor,i=this,n=new FileReader;n.readAsDataURL(t),n.onload=function(){var t=new Image;t.src=this.result,t.onload=function(){var n=e.width/t.width,a=e.height/t.height,r=n<a?n:a,o=t.width*r,s=t.height*r,h=(e.width-o)/2,c=(e.height-s)/2;e.addPhoto(t,{width:o,height:s,centerX:e.width/2,centerY:e.height/2,angle:0},!1),i.realImgInfo={width:o,height:s,position:[h,c]},i.loading=!0,x.detectPic(t,e,i.realImgInfo,(function(t){i.maskInfo=t,i.loading=!1}),(function(t){console.log(t),i.maskInfo=I.wearAMaskAsAFool(i.editor,i.realImgInfo),i.loading=!1}))}}},resumeMask:function(){this.maskInfo&&this.editor&&I.resumeMask(this.maskInfo,this.editor,this.realImgInfo)},changeMask:function(t){this.maskInfo&&this.editor&&I.changeMask(t,this.editor)},reupload:function(){this.$emit("navTo","index")},save:function(){this.$store.commit("setExportData",{url:this.editor.export(),width:this.realImgInfo.width,height:this.realImgInfo.height}),this.$emit("navTo","export")}},watch:{fileId:function(t){t!=this.currentFileId&&this.$store.state.userImgInfo&&t==this.$store.state.userImgInfo.id&&(this.loadImg(this.$store.state.userImgInfo.file),this.currentFileId=t)}}},$=D,A=(i("984a"),Object(l["a"])($,g,f,!1,null,"534563f9",null)),U=A.exports,N=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"export"}},[i("p",{staticClass:"img-container"},[i("img",{attrs:{src:t.imgUrl}})]),i("p",{staticClass:"title"},[t._v("长按或右键保存图片")]),i("p",{staticClass:"control"},[i("button",{on:{click:t.backToEditor}},[t._v("继续编辑")]),i("button",{on:{click:t.backToIndex}},[t._v("重选图片")])])])},q=[],R={data:function(){return{imgUrl:this.$store.state.exportData.url}},methods:{backToIndex:function(){this.$emit("navTo","index")},backToEditor:function(){this.$emit("navTo","editor")}},created:function(){this.$store.state.exportData||this.$emit("navTo","index")}},X=R,H=(i("7290"),Object(l["a"])(X,N,q,!1,null,"6eb51ef6",null)),W=H.exports,Y={name:"app",components:{Index:d,Editor:U,Export:W},data:function(){return{nav:"index",currentFileId:0}},methods:{navTo:function(t,e){this.nav=t,e&&(this.currentFileId=e)}}},B=Y,z=(i("034f"),Object(l["a"])(B,a,r,!1,null,null,null)),G=z.exports,J=i("2f62");n["a"].use(J["a"]);var V={userImgInfo:null,exportData:null},K={},Q={},Z={setUserImgInfo:function(t,e){t.userImgInfo=e},setExportData:function(t,e){t.exportData=e}},tt=new J["a"].Store({state:V,getters:K,actions:Q,mutations:Z});n["a"].config.productionTip=!1,new n["a"]({store:tt,render:function(t){return t(G)}}).$mount("#app")},"610f":function(t,e,i){},7290:function(t,e,i){"use strict";var n=i("610f"),a=i.n(n);a.a},"85ec":function(t,e,i){},"96e3":function(t,e,i){t.exports=i.p+"img/example.bcb76468.png"},"984a":function(t,e,i){"use strict";var n=i("bdc4"),a=i.n(n);a.a},b975:function(t,e,i){},bdc4:function(t,e,i){},e99a:function(t,e,i){"use strict";var n=i("b975"),a=i.n(n);a.a}});
//# sourceMappingURL=app.1f5b44bc.js.map